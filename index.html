<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Hello World!</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.8.2/css/bulma.min.css">
    <script src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
  </head>
  <body>
    <section class="hero is-primary is-medium">
      <!-- Hero head: will stick at the top -->
      <div class="hero-head">
        <nav class="navbar">
          <div class="container">
            <div class="navbar-brand">
              <a class="navbar-item">
                <span>Configure</span>
              </a>
              <span class="navbar-burger burger" data-target="navbarMenuHeroA">
                <span></span>
                <span></span>
                <span></span>
              </span>
            </div>
            <div id="navbarMenuHeroA" class="navbar-menu">
              <div class="navbar-end">
                <span class="navbar-item">
                  <a class="button is-primary is-inverted">
                    <span class="icon">
                      <i class="fab fa-times-circle"></i>
                    </span>                    
                  </a>
                </span>
                <span class="navbar-item">
                  <a class="button is-primary is-inverted">
                    <div class="control">
                      <button id="close" class="button is-link is-right">Close</button>
                    </div>                  
                  </a>
                </span>                
              </div>
            </div>
          </div>
        </nav>
      </div>
    
      <!-- Hero content: will be in the middle -->
      <div class="hero-body">
        <div class="tile is-vertical is-3">
          <div class="tile">
            <div class="tile is-parent is-vertical">
              <div class="field">
                <label class="label">Username</label>
                <div class="control has-icons-left has-icons-right">
                  <input class="input" id="username" type="text" placeholder="Azure Devops or TFS username" />
                </div>
                <p class="help is-success">Azure Devops or TFS username</p>
              </div>
              <div class="field">
                <label class="label">PAT</label>
                <div class="control has-icons-left has-icons-right">
                  <input class="input" id="pat" type="text" placeholder="Personal Access Token" />
                </div>
                <p class="help is-success">Where do I find this?</p>
              </div>
              <div class="field">
                <label class="label">Poll Interval</label>
                <div class="control">
                  <input class="input" id="pollInterval" type="text" />
                </div>
              </div>
              <div class="field">
                <label class="label">Failure Threshold</label>
                <div class="control">
                  <input class="input" id="failureThreshold" type="text" />
                </div>
              </div>            
              <div class="control">
                <button id="verify" class="button is-link is-right">Verify Credentials</button>
              </div>
            </div>
          </div>
        </div>

        <div class="tabs">
          <ul>
            <li id="settings.tfs.tab" onclick="toggleTab('tfs')" class="is-active"><a>TFS</a></li>
            <li id="settings.azure.tab" onclick="toggleTab('azure')" ><a>AzureDevOps</a></li>
          </ul>
        </div>

        <!-- TFS Settings -->
        <div id="settings.tfs" class="tile is-vertical is-3">
          <h1 class="title">TFS Settings</h1>
          <div class="tile">
            <div class="tile is-parent is-vertical">
              <div class="field">
                <label class="label">Instance</label>
                <div class="control">
                  <input class="input" id="tfs.instance" type="text" />
                </div>
              </div>
              <div class="field">
                <label class="label">Collection</label>
                <div class="control">
                  <input class="input" id="tfs.collection" type="text" />
                </div>
              </div>
              <div class="field">
                <label class="label">Project</label>
                <div class="control">
                  <input class="input" id="tfs.project" type="text" />
                </div>
                <p class="help is-success">Where do I find this?</p>
              </div>
              <div class="field">
                <label class="label">Release Definition Id</label>
                <div class="control">
                  <input class="input" id="tfs.releaseDefinitionId" type="text" />
                </div>
              </div>
              <div class="field">
                <label class="label">Environment Id</label>
                <div class="control">
                  <input class="input" id="tfs.environmentId" type="text" />
                </div>
              </div>
              <div class="field">
                <label class="label">Api Version</label>
                <div class="control">
                  <input class="input" id="tfs.apiVersion" type="text" placeholder="4.1-preview.2" />
                </div>
              </div> 
            </div>
          </div>
        </div> 

        <!-- AzureDevOps Settings -->
        <div id="settings.azure" class="tile is-vertical is-3">
          <h1 class="title">AzureDevOps Settings</h1>
          <div class="tile">
            <div class="tile is-parent is-vertical">
              <div class="field">
                <label class="label">Organization</label>
                <div class="control">
                  <input class="input" id="azure.organization" type="text" />
                </div>
              </div>
              <div class="field">
                <label class="label">Project</label>
                <div class="control">
                  <input class="input" id="azure.project" type="text" />
                </div>
              </div>
              <div class="field">
                <label class="label">Release Definition Id</label>
                <div class="control">
                  <input class="input" id="azure.releaseDefinitionId" type="text" />
                </div>                
              </div>
              <div class="field">
                <label class="label">Environment Id</label>
                <div class="control">
                  <input class="input" id="azure.environmentId" type="text" />
                </div>
              </div>
              <div class="field">
                <label class="label">Api Version</label>
                <div class="control">
                  <input class="input" id="azure.apiVersion" type="text" placeholder="5.1"/>
                </div>
              </div>
            </div>
          </div>
        </div> 

        <footer class="footer">
          <div class="control">
            <button id="save" class="button is-link is-right">Save</button>
          </div>
          <article id="errorModal" class="message is-danger is-hidden-tablet is-hidden-desktop">
            <div class="message-header">
              <p>Danger</p>
              <button id="closeModal" onclick="closeModal()"  class="delete" aria-label="delete"></button>
            </div>
            <div id="errors" class="message-body"></div>
          </article>           
        </footer>        
      </div>    
    </section>   

    <script type='text/javascript'>
      const lib = require('./lib')
      const log = require('electron-log');
      document.addEventListener('DOMContentLoaded',pageLoaded);

      function closeModal() {
        document.getElementById('errorModal').className = 'message is-hidden-tablet is-danger is-hidden-desktop'
      }

      function toggleTab(option) {
        var inActiveOption = ''
        if(option == 'azure') {
          inActiveOption = 'tfs'
        } else {
          inActiveOption = 'azure'
        }

        document.getElementById(`settings.${option}.tab`).className = 'is-active'
        document.getElementById(`settings.${option}`).className = 'tile is-vertical is-3'
        document.getElementById(`settings.${inActiveOption}.tab`).className = ''
        document.getElementById(`settings.${inActiveOption}`).className = 'tile is-vertical is-3 is-hidden-desktop is-hidden-tablet'
      }

      function pageLoaded(){
          console.log('The page is loaded')       
          const appConfig = lib.getConfig('./config.json')
          document.getElementById('username').value = appConfig.username
          document.getElementById('pat').value = appConfig.pat
          document.getElementById('pollInterval').value = appConfig.pollInterval
          document.getElementById('failureThreshold').value = appConfig.failureThreshold          

          if(appConfig.tfsOrazure == "tfs") {
            document.getElementById('tfs.instance').value = appConfig.tfs.instance 
            document.getElementById('tfs.collection').value = appConfig.tfs.collection
            document.getElementById('tfs.project').value = appConfig.tfs.project
            document.getElementById('tfs.releaseDefinitionId').value = appConfig.tfs.releaseDefinitionId
            document.getElementById('tfs.environmentId').value = appConfig.tfs.environmentId
            document.getElementById('tfs.apiVersion').value = appConfig.tfs.apiVersion
            toggleTab('tfs')
          } else if(appConfig.tfsOrazure == "azure") {
            document.getElementById('azure.organization').value = appConfig.azure.organization
            document.getElementById('azure.project').value = appConfig.azure.project
            document.getElementById('azure.releaseDefinitionId').value = appConfig.azure.releaseDefinitionId
            document.getElementById('azure.environmentId').value = appConfig.azure.environmentId
            document.getElementById('azure.apiVersion').value = appConfig.azure.apiVersion
            toggleTab('azure')
          } else {
            log.error('Failed to load config - tfs or azure not defined')
          }
      }

      require('electron').ipcRenderer.on('some_js_Method', (event, message) => {
        console.log(message)  // Prints 'window created!'
      })

      document.getElementById('verify').onclick = function(){
        console.log('yooooooooooooooooooooooooo')
      }

      document.getElementById('close').onclick = function() {
        const electron = require('electron')
        electron.remote.getCurrentWindow().hide()
      }

      document.getElementById('save').onclick = function(){
        console.log('Save clicked')
        var tfsOrazure = ''
        if(document.getElementById('settings.tfs.tab').className.includes('active')) {
          tfsOrazure = 'tfs'
        } else {
          tfsOrazure = 'azure'
        }

        const appConfig = {
          username: document.getElementById('username').value,
          pat: document.getElementById('pat').value,
          pollInterval: document.getElementById('pollInterval').value,
          failureThreshold: document.getElementById('failureThreshold').value,
          tfsOrazure: tfsOrazure,
          tfs: {
            'instance': document.getElementById('tfs.instance').value,
            'collection': document.getElementById('tfs.collection').value,
            'project': document.getElementById('tfs.project').value,
            'releaseDefinitionId': document.getElementById('tfs.releaseDefinitionId').value,
            'environmentId': document.getElementById('tfs.environmentId').value,
            'apiVersion' : document.getElementById('tfs.apiVersion').value
          },
          azure: {
            'organization': document.getElementById('azure.organization').value,
            'project': document.getElementById('azure.project').value,
            'releaseDefinitionId': document.getElementById('azure.releaseDefinitionId').value,
            'environmentId': document.getElementById('azure.environmentId').value,
            'apiVersion' : document.getElementById('azure.apiVersion').value
          }
        }

        var validationResult = lib.validateConfig(appConfig)

        if(!validationResult.hasErrors) {
          lib.setConfig(appConfig, './config.json')
          console.log('Config updated')
        } else {
          document.getElementById('errors').innerText = validationResult.errors[0]
          document.getElementById('errorModal').className = 'message is-danger'
          console.log('TODO - show bulma error here', validationResult.errors)
        }        
      }   
    </script>  
  </body>
</html>